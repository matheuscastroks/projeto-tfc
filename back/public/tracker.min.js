!function(){"use strict";const e={API_URL:window.IH_API_URL||"",SITE_KEY:window.IH_SITE_KEY||"",DEBUG:!0,FLUSH_INTERVAL:3e3,MAX_QUEUE_SIZE:10,SESSION_TIMEOUT:18e5,ENDPOINT:"/api/events/track/batch"},t="view_property",r="search",i="click_property_card",n="toggle_favorite",a="click_contact",o="submit_lead_form",s="ih_user_id",c="ih_session_id",l="ih_last_activity",u="ih_journey",d="ih_failed_events",h="ih_utm_tags",m=(...t)=>{e.DEBUG&&console.log("[InsightHouse v2]",...t)},g=(e="id")=>`${e}_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,p=(e,t=null)=>{try{const r=localStorage.getItem(e);return r?JSON.parse(r):t}catch(e){return t}},f=(e,t)=>{try{localStorage.setItem(e,JSON.stringify(t))}catch(e){}},v=e=>document.getElementById(e),_=e=>{const t=document.getElementById(e);if(t)return"checkbox"===t.type||"radio"===t.type?t.checked:t.value||void 0},y=e=>{const t=document.getElementById(e);if(t){if("SELECT"===t.tagName&&t.multiple){if("undefined"!=typeof $&&$(t).data("selectpicker")){const e=$(t).val();return Array.isArray(e)&&e.length>0?e:void 0}const e=Array.from(t.options).filter(e=>e.selected).map(e=>e.value);return e.length>0?e:void 0}return t.value&&t.value.includes(",")?t.value.split(",").map(e=>e.trim()).filter(e=>e):t.value?[t.value]:void 0}},E=()=>{let e=p(s);return e||(e=g("user"),f(s,e)),e},b=()=>{const t=Date.now(),r=p(l,0);let i=p(c);return(!i||t-r>e.SESSION_TIMEOUT)&&(i=g("session"),f(c,i)),f(l,t),i},I=()=>{const e=p(u,[]);e.push({url:location.href,title:document.title,timestamp:Date.now()}),e.length>50&&e.shift(),f(u,e)},S=()=>{const e=p(u,[]),t=e[0]?.timestamp||Date.now();return{depth:e.length,timeOnSite:Math.floor((Date.now()-t)/1e3),returning:e.length>1}},w=()=>{const e=new URLSearchParams(window.location.search),t={};let r=!1;["utm_source","utm_medium","utm_campaign","utm_term","utm_content"].forEach(i=>{const n=e.get(i);n&&(t[i]=n,r=!0)}),r&&(f(h,t),m("Captured UTMs:",t))},T=()=>p(h,{}),A=()=>{if(/\/obrigado\/?/.test(location.pathname))return null;const e=location.pathname.match(/\/imovel\/(\d+)\//);return e?e[1]:null},L=()=>{const e=e=>Array.from(document.querySelectorAll(`input[name="${e}"]:checked`)).map(e=>e.value),t=e=>{const t=_(e);if(!t)return;const[r,i]=String(t).split(",");return{min:Number(r)||0,max:"unlimited"===i?null:Number(i)}};return{term:void 0,status:_("property-status"),type:y("residencial-property-type"),city:y("search-field-cidade"),neighborhood:y("search-field-cidadebairro"),bedrooms:e("dormitorios[]"),suites:e("suites[]"),bathrooms:e("banheiros[]"),garage:e("vagas[]"),salePrice:t("input-slider-valor-venda"),rentPrice:t("input-slider-valor-aluguel"),area:t("input-slider-area"),furnished:_("filtermobiliado"),newProperty:_("filternovo"),rooms:e("comodos[]"),leisure:e("lazer[]"),security:e("seguranca[]"),amenities:e("comodidades[]")}},N=()=>{if(!/\/obrigado\/?/.test(location.pathname))return null;const e=new URLSearchParams(location.search);return{propertyId:e.get("codigo"),interest:e.get("interesse"),value:Number(e.get("valor_venda")||0),rental_value:Number(e.get("valor_aluguel")||0),category:e.get("categoria"),type:e.get("tipo"),city:e.get("cidade"),neighborhood:e.get("bairro"),bedrooms:e.get("dormitorios"),garage:e.get("vagas"),title:e.get("titulo_anuncio"),hasName:!(!e.get("nome")&&!e.get("name")),hasEmail:!(!e.get("email")&&!e.get("e-mail")),hasPhone:!!(e.get("telefone")||e.get("phone")||e.get("celular")||e.get("whatsapp"))}},U=(e,t={})=>{const r=T();return{name:e,ts:Date.now(),userId:E(),sessionId:b(),context:{page:{url:location.href,title:document.title,referrer:document.referrer},device:{userAgent:navigator.userAgent,screen:{width:screen.width,height:screen.height},viewport:{width:window.innerWidth,height:window.innerHeight}},journey:S()},properties:{...t,...r}}},P={queue:[],timer:null,enqueue:t=>{P.queue.push(t),m("Queued:",t.name,t),P.queue.length>=e.MAX_QUEUE_SIZE?P.flush():P.scheduleFlush()},scheduleFlush:()=>{P.timer&&clearTimeout(P.timer),P.timer=setTimeout(P.flush,e.FLUSH_INTERVAL)},flush:()=>{if(0===P.queue.length)return;const t=P.queue.slice();P.queue=[];fetch(`${e.API_URL}${e.ENDPOINT}`,{method:"POST",headers:{"Content-Type":"application/json","X-Site-Key":e.SITE_KEY},body:JSON.stringify({events:t}),keepalive:!0}).then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);m("Batch sent:",t.length)}).catch(e=>{m("Send failed:",e),P.persistFailed(t),P.scheduleRetry()})},persistFailed:e=>{const t=[...p(d,[]),...e].slice(-50);f(d,t)},retryFailed:()=>{const e=p(d,[]);0!==e.length&&(f(d,[]),m("Retrying failed events:",e.length),e.forEach(e=>P.enqueue(e)))},scheduleRetry:()=>{setTimeout(P.retryFailed,1e4)}},k={init:()=>{e.SITE_KEY?(w(),I(),P.retryFailed(),k.bindGlobalEvents(),k.bindPageSpecificEvents(),m("Initialized v2")):console.error("[InsightHouse] Missing SITE_KEY. Analytics disabled.")},capture:(e,t)=>{const r=U(e,t);P.enqueue(r)},bindGlobalEvents:()=>{document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&P.flush()}),window.addEventListener("pagehide",()=>{P.flush()}),document.addEventListener("click",e=>{const t=e.target,r=t.closest('a[href*="/imovel/"]');if(r){const e=r.getAttribute("href"),t=e.match(/\/imovel\/(\d+)\//);t&&k.capture(i,{propertyId:t[1],url:e})}const o=t.closest(".btn-favoritar");if(o){const e=o.getAttribute("data-codigo"),t=o.classList.contains("favorited")?"remove":"add";k.capture(n,{propertyId:e,action:t})}const s=t.closest('a[href*="wa.me"], a[href*="api.whatsapp.com"]');if(s){const e=s.closest("[data-codigo]")?.getAttribute("data-codigo");k.capture(a,{propertyId:e,method:"whatsapp",destination:s.href})}},{passive:!0})},bindPageSpecificEvents:()=>{const e=A();e&&k.capture(t,{propertyId:e,url:location.href});const i=v("submit-main-search-form");i&&i.addEventListener("click",()=>{k.capture(r,{source:"main_search",filters:L()}),P.flush()});const n=document.querySelector(".submit-sidebar-search-form");n&&n.addEventListener("click",()=>{k.capture(r,{source:"sidebar_search",filters:L()}),P.flush()}),document.querySelectorAll(".submit-sidebar-search-form").forEach(e=>{e.addEventListener("click",()=>{k.capture(r,{source:"sidebar_search",filters:L()})})});const a=N();a&&k.capture(o,{source:"thank_you_page",...a})}};window.IH_Analytics_v2={capture:k.capture,flush:P.flush,getConfig:()=>e},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",k.init):k.init()}();